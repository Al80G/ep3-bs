{% extends layout ?: "@PayumCore/layout.html.twig" %}

{% block payum_stylesheets %}
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link type="text/css" rel="stylesheet" href="/{{ model.metadata.project }}/public/css-client/stripe.min.css">
{% endblock %}

{% block payum_body %}
    {{ parent() }}

<main id="main" class="checkout">
    <header class="header">
      <img src="/{{ model.metadata.project }}/public/imgs-client/layout/logo.png" id="logo"/>
      <a class="shop abort" href="/{{ model.metadata.project }}/public/square/booking/cancellation?bid={{ model.metadata.bid }}&confirmed=true">{{ model.metadata.locale == 'de-DE' ? 'Abbruch und zurück zu' : 'abort and back to' }} {{ model.metadata.projectShort }} Bookingsystem</a>
    </header>
    <div id="checkout">
      <div id="payment-request">
        <div id="payment-request-button">Pay Button</div>
      </div>
      <div id="alternative"></div> 
<form action="{{ actionUrl|default('') }}" method="post" id="payment-form">
     
        <p class="instruction">{{ model.metadata.locale == 'de-DE' ? 'Bezahlung mit Kreditkarte abschließen' : 'Complete your payment with credit card below' }}</p>
        <section>
          <b>{{ model.receipt_email|default("") }}</b>{{ model.description|default("") }} 
        </section>
        <section>
            <div id="card-errors" class="element-errors"></div>
        </section>
        <section>
          <h2>{{ model.metadata.locale == 'de-DE' ? 'Zahlungsinformation' : 'Payment information' }}</h2>
          <nav id="payment-methods">
          </nav>
        <div class="payment-info card visible">
            <fieldset>
              <label>
                <span>{{ model.metadata.locale == 'de-DE' ? 'Kreditkarte' : 'Card' }}</span>
                <div id="card-element" class="field"></div>
              </label>
            </fieldset>
        </div>
        </section>
  <button type="submit">{{ model.metadata.locale != 'de-DE' ? 'Pay' : '' }} €{{ model.amount/100 }} {{ model.metadata.locale == 'de-DE' ? 'zahlen' : '' }}</button>

</form> 


  </div>
</main>
  <aside id="summary">
    <div class="header">
      <h1>{{ model.metadata.locale == 'de-DE' ? 'Übersicht' : 'Overview' }}</h1>
    </div>
    <div id="order-items">
    <div class="line-item">
        <img class="image" src="/{{ model.metadata.project }}/public/imgs-client/layout/tennis-court.png" alt="square" id="logo">
        <div class="label">
          <p class="product">{{ model.metadata.productName }}</p>
          <p class="sku"></p>
        </div>
        <p class="count">{{ model.quantity|default(1) }}</p>
        <p class="price">€{{ model.amount/100 }}</p>
        </div>
    </div>
    <div id="order-total">
      <div class="line-item total">
        <p class="label">Total</p>
        <p class="price" data-total>€{{ model.amount/100 }}</p>
      </div>

    </div>
  </aside>

{% endblock %}

{% block payum_vendor_javascripts %}
    {{ parent() }}


    <!-- The required Stripe lib -->
    <script type="text/javascript" src="https://js.stripe.com/v3/"></script>

    <!-- jQuery is used only for this example; it isn't required to use Stripe -->
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

    <script type="text/javascript">

    var stripe = Stripe({{ publishable_key|json_encode|raw }});
    var elements = stripe.elements();

    // Prepare the styles for Elements.
    var style = {
    base: {
      iconColor: '#666ee8',
      color: '#31325f',
      fontWeight: 400,
      fontFamily:
        '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif',
      fontSmoothing: 'antialiased',
      fontSize: '15px',
      '::placeholder': {
        color: '#aab7c4',
      },
      ':-webkit-autofill': {
        color: '#666ee8',
      },
    },
    }; 

    // Create an instance of the card Element.
    var cardElement = elements.create('card', {style});

    // Add an instance of the card Element into the `card-element` <div>.
    cardElement.mount('#card-element');

    // Create the payment request.
    var paymentRequest = stripe.paymentRequest({
          country: 'DE',
          currency: 'eur',
          total: {
            label: '{{ model.description|default("TVaS Booking") }}',
            amount: {{ model.amount }}
          },
          requestShipping: false,
          requestPayerEmail: true
    });

    var paymentRequestButton = elements.create('paymentRequestButton', {
      paymentRequest: paymentRequest,
      style: {
        paymentRequestButton: {
          type: 'default',
          // One of 'default', 'book', 'buy', or 'donate'
          // Defaults to 'default'
    
          theme: 'dark',
          // One of 'dark', 'light', or 'light-outline'
          // Defaults to 'dark'
    
          height: '40px'
          // Defaults to '40px'. The width is always '100%'.
        },
        },
    });

    // Check the availability of the Payment Request API first.
    paymentRequest.canMakePayment().then(function(result) {
      if (result) {
        paymentRequestButton.mount('#payment-request-button');
        // Replace the instruction.
        document.getElementById('alternative').innerHTML += '<b>{{ model.metadata.locale == 'de-DE' ? 'oder ' : 'or ' }}</b><br><br>';
        // Show the payment request section.
        document.getElementById('payment-request').classList.add('visible');
      } else {
        document.getElementById('payment-request-button').style.display = 'none';
      }
    });

    jQuery(function($) {
      paymentRequest.on('paymentmethod', function(ev) {
        // Send paymentMethod to server
        var token = ev.paymentMethod.id;
      
        var $form = $('#payment-form');
 
        // Insert the token into the form so it gets submitted to the server
        $form.append($('<input type="hidden" name="stripeToken" />').val(token));
        // and submit
        $form.get(0).submit();
      });
    });    


</script>  

 
{% endblock %}

{% block payum_javascripts %}
    {{ parent() }}

    <script type="text/javascript">

        jQuery(function($) {
            $('#payment-form').submit(function(e) {
                var $form = $(this);

                // Disable the submit button to prevent repeated clicks
                $form.find('button').prop('disabled', true);
                $form.find('button').css('background', '#dadadf');

                stripe.createPaymentMethod('card', cardElement).then(stripeResponseHandler);
                // Prevent the form from submitting with the default action
                return false;
            });

            var stripeResponseHandler = function(response) {
                var $form = $('#payment-form');

                if (response.error) {
                    // Show the errors on the form
                    $form.find('#card-errors').text(response.error.message
                        + " ");
                    $form.find('button').prop('disabled', false);
                    $form.find('button').css('background', '#666ee8');

                } else {
                    // token is the created payment method's id
                    var token = response.paymentMethod.id;
                    // Insert the token into the form so it gets submitted to the server
                    $form.append($('<input type="hidden" name="stripeToken" />').val(token));
                    // and re-submit
                    $form.get(0).submit();
                }
            };
        });

    </script>

{% endblock %}
